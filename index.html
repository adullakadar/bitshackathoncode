<!doctype html>
<html lang="en">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Message Hub - Professional Messaging Interface</title>

        <style>
                :root {
                        --bg: linear-gradient(180deg, #e6eef8 0%, #f6f9ff 100%);
                        /* stronger contrasting page background */
                        --card-bg: #ffffff;
                        --text: #0b1220;
                        /* deep charcoal for strong contrast */
                        --muted: #6b7280;
                        /* muted text */
                        --primary: #0b5fff;
                        /* vibrant blue */
                        --primary-strong: #074bd6;
                        --accent: #00bfa6;
                        /* teal accent */
                        --border: #e6edff;
                        /* soft bluish border */
                }

                /* Toggle */
                .toggle-row { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
                .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
                .switch input { opacity: 0; width: 0; height: 0; }
                .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e7eb; transition: .2s; border-radius: 999px; }
                .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
                input:checked + .slider { background-color: var(--primary); }
                input:checked + .slider:before { transform: translateX(20px); }

                /* Reset */
                * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                }

                body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        background: var(--bg);
                        color: var(--text);
                        padding: 36px;
                        /* a bit more breathing room so the card sits off the page */
                        line-height: 1.6;
                }

                .container {
                        max-width: 900px;
                        margin: 0 auto;
                        /* ensure the card stands out from the background */
                        padding: 8px;
                }

                /* Main Card */
                .main-card {
                        background: var(--card-bg);
                        border-radius: 12px;
                        border: 1px solid rgba(11, 17, 32, 0.04);
                        /* slightly darker border to separate from background */
                        box-shadow: 0 12px 40px rgba(11, 17, 32, 0.10);
                        /* stronger shadow so card is clearly separated */
                        overflow: hidden;
                }

                /* Header */
                .header {
                        padding: 24px 28px;
                        border-bottom: 1px solid rgba(11, 17, 32, 0.05);
                        background: linear-gradient(90deg, rgba(11, 95, 255, 0.06), rgba(0, 191, 166, 0.03));
                }

                .header-content {
                        display: flex;
                        align-items: center;
                        gap: 14px;
                }

                .header-icon {
                        width: 40px;
                        height: 40px;
                        border-radius: 8px;
                        background: var(--primary);
                        color: #ffffff;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        box-shadow: 0 4px 14px rgba(11, 95, 255, 0.18);
                }

                .header-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: var(--primary-strong);
                        letter-spacing: -0.01em;
                }

                .header-subtitle {
                        font-size: 13px;
                        color: var(--muted);
                }

                /* Section Labels */
                .section-label {
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text);
                        margin-bottom: 10px;
                        letter-spacing: 0.03em;
                        text-transform: uppercase;
                }

                /* Conversation Area */
                .conversation-section {
                        padding: 24px 28px;
                        border-bottom: 1px solid rgba(11, 17, 32, 0.04);
                }

                #replies {
                        min-height: 240px;
                        max-height: 420px;
                        background: linear-gradient(180deg, #ffffff, #f8fbff);
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        padding: 20px;
                        overflow-y: auto;
                }

                #replies::-webkit-scrollbar {
                        width: 7px;
                }

                #replies::-webkit-scrollbar-thumb {
                        background: rgba(11, 17, 32, 0.12);
                        border-radius: 4px;
                }

                .empty-state {
                        text-align: center;
                        color: var(--muted);
                }

                .empty-state-icon {
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        background: linear-gradient(180deg, rgba(11, 95, 255, 0.12), rgba(0, 191, 166, 0.06));
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        margin: 0 auto 10px;
                        font-size: 22px;
                        color: var(--primary-strong);
                }

                /* Composer Section */
                .composer-section {
                        padding: 24px 28px;
                }

                .form-label {
                        font-size: 13px;
                        font-weight: 700;
                        margin-bottom: 6px;
                        color: var(--text);
                }

                #message {
                        width: 100%;
                        min-height: 120px;
                        border-radius: 8px;
                        padding: 12px 16px;
                        border: 1px solid rgba(11, 17, 32, 0.08);
                        font-size: 14px;
                        resize: vertical;
                        background: #ffffff;
                        color: var(--text);
                        transition: border 0.15s ease, box-shadow 0.15s ease;
                }

                #message:focus {
                        outline: none;
                        border-color: var(--primary);
                        box-shadow: 0 6px 18px rgba(11, 95, 255, 0.08);
                }

                #message::placeholder {
                        color: #9aa4bb;
                }

                /* Upload Zone */
                .upload-actions {
                        display: grid;
                        grid-template-columns: 1fr auto;
                        gap: 16px;
                        margin-top: 20px;
                        align-items: end;
                }

                #upload-zone {
                        border: 2px dashed var(--border);
                        padding: 24px;
                        border-radius: 8px;
                        background: #ffffff;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.18s ease;
                }

                #upload-zone:hover {
                        background: linear-gradient(180deg, #f8fbff, #ffffff);
                        border-color: var(--primary-strong);
                }

                #upload-zone.drag-over {
                        background: #f0f7ff;
                        border-color: var(--primary-strong);
                        box-shadow: 0 10px 30px rgba(11, 95, 255, 0.06);
                }

                .upload-icon {
                        font-size: 20px;
                        margin-bottom: 8px;
                        color: var(--primary);
                }

                .upload-text {
                        font-size: 14px;
                        color: var(--text);
                }

                .upload-text-highlight {
                        text-decoration: underline;
                        font-weight: 700;
                        color: var(--primary-strong);
                }

                .upload-hint {
                        font-size: 12px;
                        color: var(--muted);
                        margin-top: 2px;
                }

                #documents {
                        display: none;
                }

                /* Send Button */
                #send {
                        padding: 12px 32px;
                        background: var(--primary);
                        color: #ffffff;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                        transition: transform 0.12s ease, background 0.12s ease, box-shadow 0.12s ease;
                        box-shadow: 0 8px 24px rgba(11, 95, 255, 0.12);
                }

                #send:hover {
                        background: var(--primary-strong);
                        transform: translateY(-1px);
                }

                #send:active {
                        transform: translateY(1px);
                        box-shadow: none;
                }

                /* Responsive */
                @media (max-width: 768px) {
                        .upload-actions {
                                grid-template-columns: 1fr;
                        }

                        #send {
                                width: 100%;
                        }
                }
        </style>
</head>

<body>

        <div class="container">
                <div class="main-card">

                        <!-- Header -->
                        <header class="header">
                                <div class="header-content">
                                        <div class="header-icon">ðŸ’¬</div>
                                        <div>
                                                <h1 class="header-title">Message Hub</h1>
                                                <p class="header-subtitle">Professional messaging and document sharing
                                                </p>
                                        </div>
                                </div>
                        </header>

                        <!-- Conversation -->
                        <section class="conversation-section">
                                <div class="section-label">Conversation</div>

                                <div id="replies">
                                        <div class="empty-state">
                                                <div class="empty-state-icon">ðŸ’¬</div>
                                                <p>Your conversation will appear here...</p>
                                        </div>
                                </div>
                        </section>

                        <!-- Composer -->
                        <section class="composer-section">
                                <label class="form-label" for="message">Your Message</label>
                                <textarea id="message" placeholder="Type your message here..."></textarea>

                                <div class="upload-actions">
                                        <div>
                                                <label class="form-label">Upload Documents</label>
                                                <div id="upload-zone">
                                                        <div class="upload-icon">ðŸ“Ž</div>
                                                        <p class="upload-text">
                                                                <span id="upload-status">Drop files or <span
                                                                                class="upload-text-highlight">browse</span></span>
                                                        </p>
                                                        <p class="upload-hint">Multiple files supported (TXT only)</p>
                                                        <div id="file-list" class="file-list"></div>
                                                </div>
                                                <input type="file" id="documents" name="documents" multiple accept=".txt,text/plain">

                                                <div class="toggle-row" title="Include employees.json context in the request">
                                                        <label class="form-label" style="margin:0; font-weight:600;">Include employees.json</label>
                                                        <label class="switch">
                                                                <input type="checkbox" id="include-employees" checked>
                                                                <span class="slider"></span>
                                                        </label>
                                                </div>
                                        </div>

                                        <button id="send">Send</button>
                                </div>
                        </section>

                </div>
        </div>

        <!-- JS -->
        <script>
                const uploadZone = document.getElementById("upload-zone");
                const fileInput = document.getElementById("documents");
                const fileList = document.getElementById("file-list");
                const uploadStatus = document.getElementById("upload-status");
                const replies = document.getElementById("replies");
                const sendBtn = document.getElementById("send");
                const messageEl = document.getElementById("message");
                const includeEmployeesEl = document.getElementById("include-employees");

                uploadZone.addEventListener("click", () => fileInput.click());

                uploadZone.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        uploadZone.classList.add("drag-over");
                });

                uploadZone.addEventListener("dragleave", () => {
                        uploadZone.classList.remove("drag-over");
                });

                uploadZone.addEventListener("drop", (e) => {
                        e.preventDefault();
                        uploadZone.classList.remove("drag-over");
                        // Keep only .txt files
                        const dt = new DataTransfer();
                        const dropped = Array.from(e.dataTransfer.files || []);
                        for (const f of dropped) {
                                const isTxt = (f.type === 'text/plain') || (f.name || '').toLowerCase().endsWith('.txt');
                                if (isTxt) dt.items.add(f);
                        }
                        fileInput.files = dt.files;
                        handleFiles(fileInput.files);
                });

                fileInput.addEventListener("change", () => handleFiles(fileInput.files));

                function handleFiles(files) {
                        if (files.length > 0) {
                                const names = Array.from(files).map(f => f.name).join(", ");
                                fileList.textContent = `${files.length} file(s): ${names}`;
                                uploadStatus.innerHTML = `<span class="upload-text-highlight">${files.length} selected</span>`;
                        } else {
                                fileList.textContent = "";
                                uploadStatus.innerHTML = `Drop files or <span class="upload-text-highlight">browse</span>`;
                        }
                }

                function escapeHtml(s) {
                        return s
                                .replace(/&/g, "&amp;")
                                .replace(/</g, "&lt;")
                                .replace(/>/g, "&gt;");
                }

                function formatReply(text) {
                        if (!text) return "";
                        const escaped = escapeHtml(text);
                        const bolded = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                        return bolded.replace(/\n/g, '<br>');
                }

                function extractMarkdownTable(rawText) {
                        if (!rawText) return { table: null, eids: [], headers: [], rows: [], objects: [] };
                        // Split and strip code fences
                        const rawLines = rawText.split(/\r?\n/);
                        const lines = rawLines.filter(line => !/^\s*```/.test(line));
                        let start = -1;
                        const sepRegex = /^\s*\|?\s*(?:\:?[-]{2,}\:?)(?:\s*\|\s*\:?[-]{2,}\:?)*\s*\|?\s*$/;
                        for (let i = 0; i < lines.length; i++) {
                                const l = lines[i];
                                if (!l || l.indexOf('|') === -1) continue;
                                // Look ahead up to 3 lines for a separator row, skipping blanks
                                let foundSep = false;
                                for (let j = i + 1; j <= i + 3 && j < lines.length; j++) {
                                        const ln = (lines[j] || '').trim();
                                        if (!ln) continue;
                                        if (sepRegex.test(ln)) { foundSep = true; break; }
                                        // If a non-separator with no pipes appears, abort this header candidate
                                        if (ln.indexOf('|') === -1) break;
                                }
                                if (foundSep) { start = i; break; }
                        }
                        if (start === -1) return { table: null, eids: [], headers: [], rows: [], objects: [] };
                        // Determine end: consume subsequent rows that look like table rows (contain '|')
                        let end = start + 1;
                        for (; end < lines.length; end++) {
                                if (lines[end].indexOf('|') === -1) break;
                        }
                        const tableLines = lines.slice(start, end);
                        const table = tableLines.join('\n');
                        const splitLine = (line) => {
                                const parts = line.split('|').map(s => s.trim());
                                // remove leading/trailing empties due to starting/ending pipe
                                if (parts.length && parts[0] === '') parts.shift();
                                if (parts.length && parts[parts.length - 1] === '') parts.pop();
                                return parts;
                        };
                        const headers = splitLine(tableLines[0]);
                        const headersLower = headers.map(h => h.toLowerCase());
                        const eidIdx = headersLower.findIndex(h => h === 'eid' || h === 'id' || h.includes('eid') || h.includes('employee id'));
                        const emailIdx = headersLower.findIndex(h => h === 'email' || h === 'e-mail' || h.includes('email'));
                        const nameIdx = headersLower.findIndex(h => h === 'name' || h.includes('full name'));
                        let eids = [];
                        const rows = [];
                        const objects = [];
                        for (let r = 2; r < tableLines.length; r++) { // skip header and separator
                                const cols = splitLine(tableLines[r]);
                                if (cols.filter(Boolean).length === 0) continue;
                                const cleaned = cols.map(c => c.replace(/^`+|`+$/g, '').replace(/^\*\*|\*\*$/g, '').replace(/^\*|\*$/g, ''));
                                rows.push(cleaned);
                                const obj = {};
                                headers.forEach((h, i) => { obj[h] = (cleaned[i] || ''); });
                                objects.push(obj);
                                if (eidIdx >= 0 && cleaned.length > eidIdx) {
                                        const val = cleaned[eidIdx];
                                        if (val) eids.push(val);
                                }
                        }
                        eids = Array.from(new Set(eids));
                        return { table, eids, headers, rows, objects, eidIdx, emailIdx, nameIdx };
                }

                async function sendToChat() {
                        const files = fileInput.files;
                        const message = messageEl.value.trim();
                        if ((!files || files.length === 0) && !message) {
                                alert("Type a message or attach at least one file.");
                                return;
                        }

                        // Reset conversation context for this new message
                        replies.innerHTML = "";

                        const formData = new FormData();
                        formData.append("message", message);
                        formData.append("includeEmployees", includeEmployeesEl && includeEmployeesEl.checked ? "true" : "false");
                        for (const f of files) formData.append("documents", f);

                        sendBtn.disabled = true;
                        sendBtn.textContent = "Sending...";
                        try {
                                const res = await fetch("/chat", { method: "POST", body: formData });
                                const data = await res.json();
                                if (!res.ok || !data.ok) throw new Error(data?.error ? JSON.stringify(data.error) : `HTTP ${res.status}`);

                                const msg = document.createElement("div");
                                const rawReply = data.reply || '';
                                msg.innerHTML = `<div style="margin-bottom:6px"><strong>Sent:</strong> ${escapeHtml(message) || '(no text)'}${files.length ? ` | Files: ${Array.from(files).map(f=>escapeHtml(f.name)).join(', ')}` : ''}</div><div><strong>Reply:</strong> ${rawReply ? formatReply(rawReply) : '(no reply text)'}</div>`;
                                
                                // Detect employees table and add actions
                                const { table, eids, headers } = extractMarkdownTable(rawReply);
                                if (table) {
                                        const actions = document.createElement('div');
                                        actions.style.marginTop = '8px';
                                        const downloadBtn = document.createElement('button');
                                        downloadBtn.textContent = 'Download Table';
                                        downloadBtn.style.marginRight = '8px';
                                        downloadBtn.addEventListener('click', () => {
                                                const blob = new Blob([table], { type: 'text/plain;charset=utf-8' });
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = 'employees-table.txt';
                                                document.body.appendChild(a);
                                                a.click();
                                                a.remove();
                                                URL.revokeObjectURL(url);
                                        });
                                        
                                        const notifyBtn = document.createElement('button');
                                        notifyBtn.textContent = 'Add Employees to Project';
                                        notifyBtn.style.marginRight = '8px';
                                        notifyBtn.addEventListener('click', () => {
                                                // Build modal dynamically
                                                const modal = document.createElement('div');
                                                modal.style.position = 'fixed';
                                                modal.style.inset = '0';
                                                modal.style.background = 'rgba(0,0,0,0.45)';
                                                modal.style.display = 'flex';
                                                modal.style.alignItems = 'center';
                                                modal.style.justifyContent = 'center';
                                                modal.style.zIndex = '1000';

                                                const card = document.createElement('div');
                                                card.style.background = '#fff';
                                                card.style.color = '#111827';
                                                card.style.borderRadius = '8px';
                                                card.style.width = 'min(800px, 92vw)';
                                                card.style.maxHeight = '80vh';
                                                card.style.overflow = 'auto';
                                                card.style.boxShadow = '0 10px 30px rgba(0,0,0,0.25)';
                                                card.style.padding = '16px';

                                                const header = document.createElement('div');
                                                header.style.display = 'flex';
                                                header.style.alignItems = 'center';
                                                header.style.justifyContent = 'space-between';
                                                const title = document.createElement('h3');
                                                title.textContent = 'Suggested Employees';
                                                const closeBtn = document.createElement('button');
                                                closeBtn.textContent = 'Close';
                                                closeBtn.onclick = () => modal.remove();
                                                header.appendChild(title);
                                                header.appendChild(closeBtn);

                                                const controls = document.createElement('div');
                                                controls.style.margin = '8px 0 12px 0';
                                                const projectInput = document.createElement('input');
                                                projectInput.type = 'text';
                                                projectInput.placeholder = 'Project name';
                                                projectInput.style.width = '60%';
                                                projectInput.style.marginRight = '8px';
                                                projectInput.style.padding = '6px 8px';
                                                projectInput.style.border = '1px solid #e5e7eb';
                                                projectInput.style.borderRadius = '6px';
                                                controls.appendChild(projectInput);

                                                const tableWrap = document.createElement('div');
                                                tableWrap.style.overflowX = 'auto';
                                                const tbl = document.createElement('table');
                                                tbl.style.width = '100%';
                                                tbl.style.borderCollapse = 'collapse';
                                                tbl.style.fontSize = '14px';

                                                const thead = document.createElement('thead');
                                                const htr = document.createElement('tr');
                                                ['EID','Name','Email','Action'].forEach(h => {
                                                        const th = document.createElement('th');
                                                        th.textContent = h;
                                                        th.style.textAlign = 'left';
                                                        th.style.borderBottom = '1px solid #e5e7eb';
                                                        th.style.padding = '8px';
                                                        htr.appendChild(th);
                                                });
                                                thead.appendChild(htr);

                                                const tbody = document.createElement('tbody');
                                                const { headers: H, objects, eidIdx, emailIdx, nameIdx } = extractMarkdownTable(rawReply);
                                                objects.forEach(obj => {
                                                        const tr = document.createElement('tr');
                                                        tr.style.borderBottom = '1px solid #f3f4f6';
                                                        const eid = (eidIdx >= 0) ? (obj[H[eidIdx]] || '') : (obj['EID'] || obj['eid'] || '');
                                                        const name = (nameIdx >= 0) ? (obj[H[nameIdx]] || '') : (obj['Name'] || obj['name'] || '');
                                                        const email = (emailIdx >= 0) ? (obj[H[emailIdx]] || '') : (obj['Email'] || obj['email'] || '');
                                                        const tdE = document.createElement('td'); tdE.textContent = eid; tdE.style.padding = '8px';
                                                        const tdN = document.createElement('td'); tdN.textContent = name; tdN.style.padding = '8px';
                                                        const tdM = document.createElement('td'); tdM.textContent = email; tdM.style.padding = '8px';
                                                        const tdA = document.createElement('td'); tdA.style.padding = '8px';
                                                        const emailBtn = document.createElement('button');
                                                        emailBtn.textContent = 'Email';
                                                        emailBtn.addEventListener('click', () => {
                                                                const proj = projectInput.value.trim();
                                                                const subject = proj ? `Added to project: ${proj}` : 'Project update';
                                                                const body = `Hello ${name || ''},\n\nYou have been added to the project. ${proj || ''}.\n\nRegards,\nProject Admin`;
                                                                const to = email || prompt('Recipient email for ' + (name || eid || 'employee') + ':');
                                                                if (!to) return;
                                                                window.open(
                                                                        `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,
                                                                        '_blank',
                                                                        'noopener,noreferrer'
                                                                );
                                                        });
                                                        tdA.appendChild(emailBtn);
                                                        tr.appendChild(tdE);
                                                        tr.appendChild(tdN);
                                                        tr.appendChild(tdM);
                                                        tr.appendChild(tdA);
                                                        tbody.appendChild(tr);
                                                });

                                                tbl.appendChild(thead);
                                                tbl.appendChild(tbody);
                                                tableWrap.appendChild(tbl);

                                                card.appendChild(header);
                                                card.appendChild(controls);
                                                card.appendChild(tableWrap);
                                                modal.appendChild(card);
                                                document.body.appendChild(modal);
                                        });
                                        actions.appendChild(notifyBtn);
                                        actions.appendChild(downloadBtn);
                                        msg.appendChild(actions);
                                }
                                replies.appendChild(msg);

                                // Reset UI
                                fileInput.value = "";
                                handleFiles(fileInput.files);
                                // Clear message to ensure fresh context next time
                                messageEl.value = '';
                        } catch (err) {
                                const msg = document.createElement("div");
                                msg.style.color = "#b91c1c";
                                msg.innerHTML = `<strong>Error:</strong> ${err.message}`;
                                replies.appendChild(msg);
                        } finally {
                                sendBtn.disabled = false;
                                sendBtn.textContent = "Send";
                        }
                }

                sendBtn.addEventListener("click", sendToChat);
        </script>

</body>

</html>